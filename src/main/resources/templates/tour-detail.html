<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{client-layout :: head(${tour.name})}"></head>

<body>
<nav th:replace="~{client-layout :: navbar}"></nav>

<div class="bg-light py-3 border-bottom">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/tours" class="text-decoration-none">Danh sách Tour</a></li>
                <li class="breadcrumb-item active fw-bold" aria-current="page" th:text="${tour.name}"></li>
            </ol>
        </nav>
    </div>
</div>

<div class="container py-5 mb-5">
    <div class="row g-5">
        <div class="col-lg-8">
            <h1 class="fw-bold mb-2 text-primary display-6" th:text="${tour.name}"></h1>

            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="text-warning fs-5">
                    <span class="fw-bold text-dark me-1">4.5</span>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star"></i>
                    <i class="fa-solid fa-star-half-stroke"></i>
                </div>
                <span class="text-muted small border-start ps-3">(120 đánh giá)</span>
                <span class="text-muted small border-start ps-3"><i class="fa-solid fa-eye me-1"></i> 1.5k lượt xem</span>
                <span class="text-muted small border-start ps-3"><i class="fa-solid fa-barcode me-1"></i> Mã: [[${tour.code}]]</span>
            </div>

            <div class="d-flex align-items-center gap-4 text-muted mb-4 small fw-bold text-uppercase bg-light p-3 rounded-3">
                <span><i class="fa-regular fa-clock text-warning me-2"></i> [[${tour.duration}]]</span>
                <span><i class="fa-solid fa-location-dot text-danger me-2"></i> [[${tour.departurePoint}]]</span>
                <span><i class="fa-solid fa-bus text-success me-2"></i> [[${tour.transport}]]</span>
            </div>

            <div class="card border-0 shadow-sm overflow-hidden mb-4 rounded-4 position-relative">
                <img th:src="${tour.images != null && !tour.images.isEmpty() ? tour.images[0].imageUrl : 'https://via.placeholder.com/800x450'}"
                     class="w-100 object-fit-cover" style="height: 450px;" alt="Tour Image">

                <button class="btn btn-light rounded-circle position-absolute top-0 end-0 m-4 shadow text-danger"
                        style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; z-index: 10; font-size: 1.5rem;"
                        th:onclick="'toggleFavorite(this, ' + ${tour.id} + ')'">
                    <i class="fa-regular fa-heart"></i>
                </button>
            </div>

            <ul class="nav nav-tabs nav-fill mb-4 fw-bold" id="tourTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#intro">Giới thiệu</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#itinerary">Lịch trình</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#policy">Giá & Chính sách</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#reviews">Đánh giá</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="intro">
                    <div class="bg-white p-4 rounded-3 shadow-sm border text-secondary" style="line-height: 1.8; text-align: justify;">
                        <h5 class="fw-bold text-dark mb-3">Điểm nhấn hành trình</h5>
                        <p style="white-space: pre-line;" th:text="${tour.description}"></p>
                    </div>
                </div>

                <div class="tab-pane fade" id="itinerary">
                    <div class="bg-white p-4 rounded-3 shadow-sm border">
                        <div th:if="${tour.itineraries == null || tour.itineraries.isEmpty()}" class="alert alert-info">
                            <i class="fa-solid fa-hammer me-2"></i>Đang cập nhật lịch trình chi tiết...
                        </div>
                        <div th:each="day : ${tour.itineraries}" class="d-flex mb-4 position-relative">
                            <div class="flex-shrink-0 text-center me-4">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm"
                                     style="width: 60px; height: 60px;">[[${day.dayNumber}]]</div>
                            </div>
                            <div class="pb-3 border-bottom w-100">
                                <h5 class="fw-bold text-dark text-uppercase">[[${day.title}]]</h5>
                                <p class="text-muted mb-0">[[${day.description}]]</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="policy">
                    <div class="bg-white p-4 rounded-3 shadow-sm border">

                        <h5 class="fw-bold text-primary mb-3"><i class="fa-solid fa-tag me-2"></i>Bảng giá tham khảo</h5>
                        <div class="table-responsive mb-4">
                            <table class="table table-bordered table-striped text-center align-middle">
                                <thead class="table-primary">
                                <tr>
                                    <th>Đối tượng</th>
                                    <th>Giá tour (VNĐ)</th>
                                    <th>Ghi chú</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td class="fw-bold">Người lớn (>10 tuổi)</td>
                                    <td class="text-danger fw-bold fs-5"
                                        th:text="${tour.schedules != null && !tour.schedules.isEmpty() ? #numbers.formatDecimal(tour.schedules[0].priceAdult, 0, 'COMMA', 0, 'POINT') : 'Liên hệ'}"></td>
                                    <td>Tiêu chuẩn 1 suất ăn + 1 ghế ngồi</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Trẻ em (5 - 9 tuổi)</td>
                                    <td class="text-danger fw-bold"
                                        th:text="${tour.schedules != null && !tour.schedules.isEmpty() ? #numbers.formatDecimal(tour.schedules[0].priceAdult * 0.75, 0, 'COMMA', 0, 'POINT') : 'Liên hệ'}"></td>
                                    <td>75% giá vé người lớn (Ngủ chung giường)</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Em bé (< 5 tuổi)</td>
                                    <td class="text-danger fw-bold"
                                        th:text="${tour.schedules != null && !tour.schedules.isEmpty() ? #numbers.formatDecimal(tour.schedules[0].priceAdult * 0.1, 0, 'COMMA', 0, 'POINT') : 'Miễn phí'}"></td>
                                    <td>10% phí bảo hiểm & vé tham quan (nếu có)</td>
                                </tr>
                                </tbody>
                            </table>
                            <small class="text-muted fst-italic">* Giá trên áp dụng cho ngày thường. Lễ tết có thể phụ thu 20-30%.</small>
                        </div>

                        <hr>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h6 class="fw-bold text-success mb-3"><i class="fa-solid fa-check-circle me-2"></i>GIÁ TOUR BAO GỒM</h6>
                                <ul class="list-unstyled text-secondary small">
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i>Xe du lịch đời mới, máy lạnh.</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i>Khách sạn tiêu chuẩn (2-3 khách/phòng).</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i>Các bữa ăn theo chương trình.</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i>Vé tham quan các điểm.</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i>Hướng dẫn viên nhiệt tình.</li>
                                    <li class="mb-2"><i class="fa-solid fa-check text-success me-2"></i>Nước suối, khăn lạnh, bảo hiểm.</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold text-danger mb-3"><i class="fa-solid fa-times-circle me-2"></i>GIÁ KHÔNG BAO GỒM</h6>
                                <ul class="list-unstyled text-secondary small">
                                    <li class="mb-2"><i class="fa-solid fa-xmark text-danger me-2"></i>Thuế VAT (8%).</li>
                                    <li class="mb-2"><i class="fa-solid fa-xmark text-danger me-2"></i>Chi phí cá nhân (giặt ủi, điện thoại...).</li>
                                    <li class="mb-2"><i class="fa-solid fa-xmark text-danger me-2"></i>Tiền Tip cho HDV và tài xế.</li>
                                    <li class="mb-2"><i class="fa-solid fa-xmark text-danger me-2"></i>Phụ thu phòng đơn (nếu ngủ 1 người).</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="reviews">
                    <div class="bg-white p-4 rounded-3 shadow-sm border">
                        <h4 class="fw-bold mb-4">Đánh giá từ khách hàng</h4>

                        <div th:if="${tour.comments != null}" th:each="cmt : ${tour.comments}" class="d-flex mb-4 pb-3 border-bottom">
                            <img src="https://ui-avatars.com/api/?name=User&background=random" class="rounded-circle me-3 shadow-sm" width="50" height="50">
                            <div class="w-100">
                                <div class="d-flex justify-content-between">
                                    <h6 class="fw-bold mb-0 text-dark" th:text="${cmt.user != null ? cmt.user.fullName : 'Ẩn danh'}">Tên khách</h6>
                                    <small class="text-muted" th:text="${cmt.createdDate != null ? #temporals.format(cmt.createdDate, 'dd/MM/yyyy HH:mm') : 'Mới đây'}"></small>
                                </div>
                                <div class="text-warning small mb-1">
                                    <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                                </div>
                                <p class="mb-0 text-secondary" th:text="${cmt.text}"></p>
                            </div>
                        </div>

                        <div class="mt-4" sec:authorize="isAuthenticated()">
                            <h6 class="fw-bold mb-3"><i class="fa-solid fa-pen-to-square me-2"></i>Viết đánh giá của bạn</h6>
                            <form th:action="@{/tour/comment}" method="post">
                                <input type="hidden" name="tourId" th:value="${tour.id}">
                                <div class="form-floating mb-3">
                                    <textarea name="content" class="form-control" style="height: 100px" required placeholder="Nội dung"></textarea>
                                    <label>Chia sẻ trải nghiệm của bạn...</label>
                                </div>
                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">
                                        <i class="fa-solid fa-paper-plane me-2"></i>Gửi đánh giá
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="alert alert-secondary mt-4 text-center" sec:authorize="!isAuthenticated()">
                            Bạn cần <a href="/login" class="fw-bold">đăng nhập</a> để viết đánh giá.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow rounded-4 sticky-top" style="top: 100px; z-index: 10;">
                <div class="card-header bg-primary text-white py-3 rounded-top-4">
                    <h5 class="mb-0 fw-bold text-center"><i class="fa-regular fa-calendar-check me-2"></i>LỊCH KHỞI HÀNH</h5>
                </div>

                <div class="card-body bg-light">
                    <div th:each="sche : ${tour.schedules}" class="bg-white p-3 rounded-3 border mb-3 shadow-sm position-relative overflow-hidden">

                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <span class="badge bg-success bg-opacity-10 text-success border border-success px-2 py-1">
                                <i class="fa-solid fa-plane-departure me-1"></i> Sắp khởi hành
                            </span>
                            <small class="text-danger fw-bold bg-danger bg-opacity-10 px-2 py-1 rounded">
                                Còn [[${sche.quota - sche.booked}]] chỗ
                            </small>
                        </div>

                        <div class="d-flex mb-2">
                            <div class="me-3 text-center" style="min-width: 60px;">
                                <span class="d-block fw-bold text-primary display-6 lh-1">[[${#temporals.format(sche.startDate, 'dd')}]]</span>
                                <small class="text-muted fw-bold text-uppercase">Tháng [[${#temporals.format(sche.startDate, 'MM')}]]</small>
                            </div>
                            <div class="border-start ps-3">
                                <h6 class="fw-bold text-dark mb-0">Ngày đi: [[${#temporals.format(sche.startDate, 'dd/MM/yyyy')}]]</h6>
                                <small class="text-muted"><i class="fa-regular fa-clock me-1"></i>Thời lượng: [[${tour.duration}]]</small>
                            </div>
                        </div>

                        <div class="bg-light p-2 rounded small text-secondary mb-3">
                            <div class="mb-1"><i class="fa-solid fa-location-dot text-danger me-2"></i>Tập trung: <strong>[[${tour.startLocation}]]</strong></div>
                            <div><i class="fa-solid fa-bus text-primary me-2"></i>Phương tiện: <strong>[[${tour.transport}]]</strong></div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <small class="text-muted d-block text-decoration-line-through fst-italic">
                                    [[${#numbers.formatDecimal(sche.priceAdult * 1.1, 0, 'COMMA', 0, 'POINT')}]]₫
                                </small>
                                <div class="text-danger fw-bold fs-4">
                                    [[${#numbers.formatDecimal(sche.priceAdult, 0, 'COMMA', 0, 'POINT')}]]₫
                                </div>
                            </div>
                            <a th:href="@{/booking/create(scheduleId=${sche.id})}" class="btn btn-primary fw-bold px-3 py-2 rounded-pill shadow-sm">
                                ĐẶT NGAY <i class="fa-solid fa-angle-right"></i>
                            </a>
                        </div>
                    </div>

                    <div th:if="${tour.schedules == null || tour.schedules.isEmpty()}" class="text-center py-5">
                        <i class="fa-solid fa-calendar-xmark fa-3x text-muted mb-3 opacity-25"></i>
                        <p class="text-muted">Chưa có lịch khởi hành.</p>
                        <button class="btn btn-outline-primary w-100 rounded-pill">Đăng ký nhận tin</button>
                    </div>
                </div>

                <div class="card-footer bg-white text-muted small py-3 rounded-bottom-4">
                    <div class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-shield-halved text-success"></i> Bảo hiểm du lịch trọn gói</div>
                    <div class="d-flex align-items-center gap-2"><i class="fa-solid fa-headset text-primary"></i> Hỗ trợ 24/7: 1900 1234</div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{client-layout :: footer}"></footer>
<div th:replace="~{client-layout :: scripts}"></div>
</body>
</html>