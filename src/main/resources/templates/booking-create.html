<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{client-layout :: head('X√°c nh·∫≠n ƒë·∫∑t Tour')}"></head>

<body class="bg-light">
<nav th:replace="~{client-layout :: navbar}"></nav>

<div class="container py-5">
    <div class="row g-5">

        <div class="col-md-5 col-lg-4 order-md-last">
            <div class="card border-0 shadow-sm rounded-4 sticky-top" style="top: 100px;">
                <div class="card-header bg-white border-0 pt-3 pb-0">
                    <h5 class="fw-bold text-primary mb-0">V√© c·ªßa b·∫°n</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3 mb-3">
                        <img th:src="${schedule.tour.images != null && !schedule.tour.images.isEmpty() ? schedule.tour.images[0].imageUrl : 'https://via.placeholder.com/100'}"
                             class="rounded-3 object-fit-cover" style="width: 80px; height: 80px;">
                        <div>
                            <h6 class="fw-bold text-dark small mb-1" th:text="${schedule.tour.name}">T√™n Tour</h6>
                            <span class="badge bg-info bg-opacity-10 text-info border border-info rounded-pill px-2">
                                <i class="fa-regular fa-clock me-1"></i> [[${schedule.tour.duration}]]
                            </span>
                        </div>
                    </div>
                    <hr class="border-secondary opacity-10">

                    <div class="mb-3 small">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-muted">Kh·ªüi h√†nh:</span>
                            <span class="fw-bold text-dark">[[${#temporals.format(schedule.startDate, 'dd/MM/yyyy')}]]</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">T·∫≠p trung:</span>
                            <span class="fw-bold text-dark text-end" style="max-width: 150px;">[[${schedule.tour.departurePoint}]]</span>
                        </div>
                    </div>
                    <hr class="border-secondary opacity-10">

                    <div id="price-breakdown" class="small mb-3">
                    </div>

                    <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                        <span class="fw-bold fs-5">T·ªîNG C·ªòNG</span>
                        <span class="fw-bold fs-4 text-danger" id="total-amount">0 ƒë</span>
                    </div>
                </div>
                <div class="card-footer bg-light text-center py-3 rounded-bottom-4">
                    <small class="text-muted"><i class="fa-solid fa-shield-halved me-1 text-success"></i>B·∫£o m·∫≠t thanh to√°n 100%</small>
                </div>
            </div>
        </div>

        <div class="col-md-7 col-lg-8">

            <h5 class="fw-bold mb-3"><span class="badge bg-primary rounded-circle me-2">1</span>S·ªë l∆∞·ª£ng h√†nh kh√°ch</h5>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="fw-bold mb-0">Ng∆∞·ªùi l·ªõn</h6>
                            <small class="text-muted">T·ª´ 10 tu·ªïi tr·ªü l√™n</small>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-primary fw-bold" th:data-price="${schedule.priceAdult}" id="price-adult-display"></span>
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity('adult', -1)">-</button>
                                <input type="number" id="adult-qty" class="form-control text-center fw-bold" value="1" min="1" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity('adult', 1)">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="fw-bold mb-0">Tr·∫ª em (5 - 9 tu·ªïi)</h6>
                            <small class="text-success fw-bold">Gi·∫£m 25%</small>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted small" th:data-price="${schedule.priceAdult * 0.75}" id="price-child-display"></span>
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity('child', -1)">-</button>
                                <input type="number" id="child-qty" class="form-control text-center fw-bold" value="0" min="0" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity('child', 1)">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-0">Em b√© (< 5 tu·ªïi)</h6>
                            <small class="text-success fw-bold">Ch·ªâ 10% v√©</small>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted small" th:data-price="${schedule.priceAdult * 0.1}" id="price-infant-display"></span>
                            <div class="input-group input-group-sm" style="width: 120px;">
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity('infant', -1)">-</button>
                                <input type="number" id="infant-qty" class="form-control text-center fw-bold" value="0" min="0" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity('infant', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h5 class="fw-bold mb-3"><span class="badge bg-primary rounded-circle me-2">2</span>Th√¥ng tin li√™n h·ªá</h5>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <form id="bookingForm" class="row g-3">
                        <input type="hidden" name="scheduleId" th:value="${schedule.id}">

                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase text-muted">H·ªç v√† t√™n *</label>
                            <input type="text" class="form-control" name="fullName" th:value="${user != null ? user.fullName : ''}" required placeholder="VD: Nguyen Van A">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small text-uppercase text-muted">S·ªë ƒëi·ªán tho·∫°i *</label>
                            <input type="tel" class="form-control" name="phone" th:value="${user != null ? user.phone : ''}" required placeholder="09xxxxxxx">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold small text-uppercase text-muted">Email (Nh·∫≠n v√© ƒëi·ªán t·ª≠) *</label>
                            <input type="email" class="form-control" name="email" th:value="${user != null ? user.email : ''}" required placeholder="email@example.com">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold small text-uppercase text-muted">Ghi ch√∫ ƒë·∫∑c bi·ªát</label>
                            <textarea class="form-control" name="note" rows="2" placeholder="VD: T√¥i ƒÉn chay, c·∫ßn gh·∫ø ƒë·∫ßu xe..."></textarea>
                        </div>
                    </form>
                </div>
            </div>

            <h5 class="fw-bold mb-3"><span class="badge bg-primary rounded-circle me-2">3</span>Thanh to√°n</h5>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush rounded-3">

                        <label class="list-group-item d-flex gap-3 align-items-center p-3 cursor-pointer">
                            <input class="form-check-input flex-shrink-0" type="radio" name="paymentMethod" value="VNPAY" checked onchange="togglePaymentInfo()">
                            <span class="d-flex align-items-center justify-content-between w-100">
                                <span><i class="fa-solid fa-credit-card me-2 text-primary"></i>Thanh to√°n VNPAY / Th·∫ª ATM</span>
                                <img src="https://vinadesign.vn/uploads/images/2023/05/vnpay-logo-vinadesign-25-12-57-55.png" height="25">
                            </span>
                        </label>

                        <label class="list-group-item d-flex gap-3 align-items-center p-3 cursor-pointer">
                            <input class="form-check-input flex-shrink-0" type="radio" name="paymentMethod" value="BANK_TRANSFER" onchange="togglePaymentInfo()">
                            <span class="d-flex align-items-center justify-content-between w-100">
                                <span><i class="fa-solid fa-qrcode me-2 text-success"></i>Chuy·ªÉn kho·∫£n Ng√¢n h√†ng (QR Code)</span>
                                <i class="fa-solid fa-university text-muted"></i>
                            </span>
                        </label>

                        <div id="bank-info" class="bg-light p-4 d-none border-top">
                            <div class="row align-items-center">
                                <div class="col-md-5 text-center">
                                    <img id="qr-code-img" src="" class="img-fluid rounded border shadow-sm bg-white p-2" alt="QR Code">
                                    <small class="d-block mt-2 text-muted fst-italic">Qu√©t m√£ ƒë·ªÉ thanh to√°n nhanh</small>
                                </div>
                                <div class="col-md-7">
                                    <h6 class="fw-bold text-primary">Th√¥ng tin chuy·ªÉn kho·∫£n</h6>
                                    <ul class="list-unstyled small mb-0">
                                        <li class="mb-2">Ng√¢n h√†ng: <strong>MB Bank (Qu√¢n ƒê·ªôi)</strong></li>
                                        <li class="mb-2">S·ªë t√†i kho·∫£n: <strong class="text-danger fs-5">0366964556</strong></li>
                                        <li class="mb-2">Ch·ªß t√†i kho·∫£n: <strong>VU MINH NHAT</strong></li>
                                        <li>N·ªôi dung: <strong class="text-primary" id="transfer-content">BOOKTOUR [SDT]</strong></li>
                                    </ul>
                                    <div class="alert alert-warning small mt-3 mb-0">
                                        <i class="fa-solid fa-triangle-exclamation me-1"></i> L∆∞u √Ω: Sau khi chuy·ªÉn kho·∫£n, vui l√≤ng b·∫•m n√∫t "Ho√†n t·∫•t ƒë·∫∑t v√©" b√™n d∆∞·ªõi. Nh√¢n vi√™n s·∫Ω g·ªçi x√°c nh·∫≠n trong 5 ph√∫t.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <label class="list-group-item d-flex gap-3 align-items-center p-3 cursor-pointer">
                            <input class="form-check-input flex-shrink-0" type="radio" name="paymentMethod" value="CASH" onchange="togglePaymentInfo()">
                            <span class="d-flex align-items-center justify-content-between w-100">
                                <span><i class="fa-solid fa-money-bill-wave me-2 text-warning"></i>Ti·ªÅn m·∫∑t t·∫°i vƒÉn ph√≤ng</span>
                                <i class="fa-solid fa-shop text-muted"></i>
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <button type="button" onclick="submitBooking()" class="btn btn-primary w-100 btn-lg py-3 fw-bold text-uppercase shadow hover-up">
                Ho√†n t·∫•t ƒë·∫∑t v√© <i class="fa-solid fa-arrow-right ms-2"></i>
            </button>
            <p class="text-center text-muted small mt-3">B·∫±ng vi·ªác b·∫•m n√∫t tr√™n, b·∫°n ƒë·ªìng √Ω v·ªõi ƒêi·ªÅu kho·∫£n & Ch√≠nh s√°ch c·ªßa ch√∫ng t√¥i.</p>
        </div>
    </div>
</div>

<footer th:replace="~{client-layout :: footer}"></footer>
<div th:replace="~{client-layout :: scripts}"></div>

<script th:inline="javascript">
    // 1. L·∫§Y GI√Å T·ª™ SERVER (THYMELEAF)
    const basePrice = [[${schedule.priceAdult}]]; // Gi√° ng∆∞·ªùi l·ªõn g·ªëc
    const childPrice = basePrice * 0.75;
    const infantPrice = basePrice * 0.1;

    let totalPrice = 0;

    // 2. KH·ªûI T·∫†O KHI LOAD TRANG
    document.addEventListener('DOMContentLoaded', function() {
        formatCurrencyDisplay();
        calculateTotal();
    });

    // 3. H√ÄM C·∫¨P NH·∫¨T S·ªê L∆Ø·ª¢NG
    function updateQuantity(type, change) {
        const input = document.getElementById(type + '-qty');
        let val = parseInt(input.value) + change;

        // Validate: Ng∆∞·ªùi l·ªõn min 1, c√≤n l·∫°i min 0
        const min = (type === 'adult') ? 1 : 0;
        if (val < min) val = min;

        input.value = val;
        calculateTotal();
    }

    // 4. H√ÄM T√çNH T·ªîNG TI·ªÄN V√Ä RENDER VIEW
    function calculateTotal() {
        const adults = parseInt(document.getElementById('adult-qty').value);
        const children = parseInt(document.getElementById('child-qty').value);
        const infants = parseInt(document.getElementById('infant-qty').value);

        totalPrice = (adults * basePrice) + (children * childPrice) + (infants * infantPrice);

        // Update T·ªïng ti·ªÅn
        document.getElementById('total-amount').innerText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalPrice);

        // Update Breakdown (Chi ti·∫øt b√™n c·ªôt ph·∫£i)
        let html = `<div class="d-flex justify-content-between mb-1">
                        <span>Ng∆∞·ªùi l·ªõn (${adults}x)</span>
                        <span>${formatMoney(adults * basePrice)}</span>
                    </div>`;

        if (children > 0) {
            html += `<div class="d-flex justify-content-between mb-1">
                        <span>Tr·∫ª em (${children}x)</span>
                        <span>${formatMoney(children * childPrice)}</span>
                    </div>`;
        }
        if (infants > 0) {
            html += `<div class="d-flex justify-content-between mb-1">
                        <span>Em b√© (${infants}x)</span>
                        <span>${formatMoney(infants * infantPrice)}</span>
                    </div>`;
        }

        document.getElementById('price-breakdown').innerHTML = html;

        // C·∫≠p nh·∫≠t QR Code n·∫øu ƒëang ch·ªçn chuy·ªÉn kho·∫£n
        updateQRCode();
    }

    // 5. H√ÄM HI·ªÇN TH·ªä TH√îNG TIN THANH TO√ÅN
    function togglePaymentInfo() {
        const method = document.querySelector('input[name="paymentMethod"]:checked').value;
        const bankInfo = document.getElementById('bank-info');

        if (method === 'BANK_TRANSFER') {
            bankInfo.classList.remove('d-none');
            updateQRCode();
        } else {
            bankInfo.classList.add('d-none');
        }
    }

    // 6. C·∫¨P NH·∫¨T QR CODE (D√ôNG API VIETQR)
    function updateQRCode() {
        // C√∫ ph√°p: https://img.vietqr.io/image/[BANK]-[ACC_NO]-[TEMPLATE].png?amount=[AMOUNT]&addInfo=[CONTENT]
        const phone = document.querySelector('input[name="phone"]').value || 'KHACH';
        const content = `BOOKTOUR ${phone}`;
        document.getElementById('transfer-content').innerText = content;

        const qrUrl = `https://img.vietqr.io/image/MB-0366964556-compact2.png?amount=${totalPrice}&addInfo=${content}`;
        document.getElementById('qr-code-img').src = qrUrl;
    }

    // 7. SUBMIT FORM (ƒê√É S·ª¨A LOGIC VNPAY)
    async function submitBooking() {
        // L·∫•y User ID t·ª´ Thymeleaf (n·∫øu c√≥)
        let currentUserId = [[${user != null ? user.id : 'null'}]];

        // Thu th·∫≠p d·ªØ li·ªáu t·ª´ Form
        const bookingData = {
            scheduleId: document.querySelector('input[name="scheduleId"]').value,
            userId: currentUserId,

            // Th√¥ng tin li√™n h·ªá
            customerName: document.querySelector('input[name="fullName"]').value,
            customerEmail: document.querySelector('input[name="email"]').value,
            customerPhone: document.querySelector('input[name="phone"]').value,
            notes: document.querySelector('textarea[name="note"]').value,
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,

            // S·ªë l∆∞·ª£ng kh√°ch (Quan tr·ªçng ƒë·ªÉ t√≠nh ti·ªÅn)
            adultCount: parseInt(document.getElementById('adult-qty').value),
            childCount: parseInt(document.getElementById('child-qty').value),
            infantCount: parseInt(document.getElementById('infant-qty').value),

            // Danh s√°ch h√†nh kh√°ch chi ti·∫øt (N·∫øu sau n√†y b·∫°n l√†m form nh·∫≠p chi ti·∫øt)
            // Hi·ªán t·∫°i ƒë·ªÉ m·∫£ng r·ªóng, Backend s·∫Ω t·ª± l·∫•y th√¥ng tin ng∆∞·ªùi ƒë·∫∑t ƒëi·ªÅn v√†o
            passengers: []
        };

        // Validate c∆° b·∫£n
        if (!bookingData.customerName || !bookingData.customerPhone || !bookingData.customerEmail) {
            alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin li√™n h·ªá!");
            return;
        }

        // Hi·ªáu ·ª©ng loading n√∫t b·∫•m
        const btn = document.querySelector('button[onclick="submitBooking()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
        btn.disabled = true;

        try {
            // B∆Ø·ªöC 1: T·∫†O ƒê∆†N H√ÄNG (BOOKING)
            console.log("ƒêang t·∫°o ƒë∆°n h√†ng...", bookingData);
            const bookingRes = await fetch('/api/v1/bookings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            });

            const bookingResult = await bookingRes.json();

            if (!bookingRes.ok) {
                throw new Error(bookingResult.message || bookingResult.error || "L·ªói t·∫°o ƒë∆°n h√†ng");
            }

            console.log("ƒê∆°n h√†ng t·∫°o th√†nh c√¥ng:", bookingResult);

            // B∆Ø·ªöC 2: X·ª¨ L√ù THANH TO√ÅN
            if (bookingData.paymentMethod === 'VNPAY') {
                // G·ªçi ti·∫øp API t·∫°o URL thanh to√°n
                console.log("ƒêang l·∫•y link VNPAY...");
                const paymentRes = await fetch('/api/v1/payment/create-vnpay-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bookingCode: bookingResult.bookingCode,
                        amount: bookingResult.totalAmount // L·∫•y s·ªë ti·ªÅn th·ª±c t·∫ø t·ª´ Server tr·∫£ v·ªÅ
                    })
                });

                const paymentResult = await paymentRes.json();

                if (paymentRes.ok && paymentResult.paymentUrl) {
                    // Chuy·ªÉn h∆∞·ªõng sang VNPAY
                    window.location.href = paymentResult.paymentUrl;
                } else {
                    alert("L·ªói t·∫°o c·ªïng thanh to√°n: " + (paymentResult.message || "Kh√¥ng x√°c ƒë·ªãnh"));
                    // N·∫øu l·ªói thanh to√°n nh∆∞ng ƒë√£ t·∫°o ƒë∆°n, chuy·ªÉn v·ªÅ l·ªãch s·ª≠
                    window.location.href = "/history";
                }

            } else {
                // Ti·ªÅn m·∫∑t ho·∫∑c Chuy·ªÉn kho·∫£n -> Xong lu√¥n
                alert("üéâ ƒê·∫∑t v√© th√†nh c√¥ng! M√£ ƒë∆°n: " + bookingResult.bookingCode + "\nCh√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm nh·∫•t.");
                window.location.href = "/history";
            }

        } catch (error) {
            console.error(error);
            alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // Helper: Format ti·ªÅn t·ªá
    function formatMoney(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    // Helper: Hi·ªÉn th·ªã gi√° ban ƒë·∫ßu
    function formatCurrencyDisplay() {
        document.getElementById('price-adult-display').innerText = formatMoney(basePrice);
        document.getElementById('price-child-display').innerText = formatMoney(childPrice);
        document.getElementById('price-infant-display').innerText = formatMoney(infantPrice);
    }
</script>

</body>
</html>